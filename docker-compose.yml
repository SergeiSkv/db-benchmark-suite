services:
  postgres:
    image: postgres:15-alpine
    container_name: benchmark-postgres
    environment:
      POSTGRES_USER: benchmark
      POSTGRES_PASSWORD: benchmark123
      POSTGRES_DB: events
      POSTGRES_INITDB_ARGS: "-E UTF8"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=512MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "work_mem=16MB"
      - "-c"
      - "max_connections=50"
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    networks:
      - benchmark

  mongodb:
    image: mongo:7.0
    container_name: benchmark-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: benchmark
      MONGO_INITDB_ROOT_PASSWORD: benchmark123
      MONGO_INITDB_DATABASE: events
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    command: mongod --wiredTigerCacheSizeGB 1
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    networks:
      - benchmark

  cassandra:
    image: cassandra:4.1
    container_name: benchmark-cassandra
    environment:
      CASSANDRA_CLUSTER_NAME: benchmark-cluster
      CASSANDRA_DC: datacenter1
      CASSANDRA_RACK: rack1
      CASSANDRA_ENDPOINT_SNITCH: GossipingPropertyFileSnitch
      MAX_HEAP_SIZE: 512M
      HEAP_NEWSIZE: 128M
      JVM_OPTS: "-Xms512M -Xmx512M"
    ports:
      - "9042:9042"
    volumes:
      - cassandra_data:/var/lib/cassandra
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    networks:
      - benchmark
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'describe cluster'"]
      interval: 30s
      timeout: 10s
      retries: 5

  clickhouse:
    image: clickhouse/clickhouse-server:23.12-alpine
    container_name: benchmark-clickhouse
    environment:
      CLICKHOUSE_DB: events
      CLICKHOUSE_USER: benchmark
      CLICKHOUSE_PASSWORD: benchmark123
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    networks:
      - benchmark

volumes:
  postgres_data:
  mongo_data:
  cassandra_data:
  clickhouse_data:

networks:
  benchmark:
    driver: bridge
